name: ğŸ”„ æè‡´ç²¾é€‰ç‚¹ç«ç‰ˆ

on:
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'stock_scanner_go.py' 
      - '.github/workflows/stock_scanner_go.yml'
  schedule:
    - cron: '38 7 * * *'    # æ¯å¤©åŒ—äº¬æ—¶é—´ 15:30 è¿è¡Œ (UTC 7:30)

permissions:
  contents: write           # æ ¸å¿ƒï¼šå¿…é¡»èµ‹äºˆå†™å…¥æƒé™

jobs:
  run_scanner:
    timeout-minutes: 60 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          pip install akshare pandas pytz numpy

      - name: ğŸš€ è¿è¡Œç‚¹ç«ç‰ˆè„šæœ¬
        run: |
          # è¿è¡Œä½ æœ€æ–°çš„å¸¦â€œç‚¹ç«å¯åŠ¨â€é€»è¾‘çš„è„šæœ¬
          python stock_scanner_go.py

      - name: ğŸ’¾ è‡ªåŠ¨åŒæ­¥å¹¶æäº¤ç»“æœ
        run: |
          # 1. é…ç½® Git åŸºç¡€ä¿¡æ¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --global core.quotepath false
          
          # 2. æš‚å­˜æ‰€æœ‰æ›´æ”¹ï¼ˆè§£å†³ä½ ä¹‹å‰æŠ¥é”™çš„å…³é”®ï¼šå…ˆ add å† stashï¼‰
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“¦ å‘ç°æ–°ç”Ÿæˆçš„ CSV æ•°æ®ï¼Œæ­£åœ¨è¿›å…¥æš‚å­˜åŒº..."
            git add .
            git stash
          fi
          
          # 3. æ‹‰å–è¿œç¨‹æ›´æ–°ï¼Œé˜²æ­¢å¤šäººåä½œæˆ–å¤šæ¬¡è¿è¡Œå¯¼è‡´çš„ Push å¤±è´¥
          git pull origin ${{ github.ref_name }} --rebase
          
          # 4. é‡Šæ”¾æš‚å­˜çš„æ–‡ä»¶
          if git stash list | grep -q "stash@{0}"; then
            echo "ğŸ”“ é‡Šæ”¾æš‚å­˜æ•°æ®åˆ°å½“å‰å·¥ä½œåŒº..."
            git stash pop
          fi
          
          # 5. æäº¤å¹¶æ¨é€
          # é‡æ–° add ç¡®ä¿æ–°ç”Ÿæˆçš„ results è¢«åŒ…å«
          git add results/*.csv
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ–°..."
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æè‡´ç²¾é€‰(å«ç‚¹ç«å¯åŠ¨): $(date +'%Y-%m-%d %H:%M')"
            git push origin ${{ github.ref_name }}
          else
            echo "âœ… æœ¬æ¬¡è¿è¡Œæœªå‘ç°æ ‡çš„å˜åŠ¨ï¼Œæ— éœ€æ›´æ–°ä»“åº“ã€‚"
          fi
